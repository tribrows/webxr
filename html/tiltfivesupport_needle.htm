<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tilt Five - CDN Fixed</title>
    
    <!-- 1. IMPORT MAP: Maps 'three' and 'needle' to stable JSDelivr URLs -->
    <script type="importmap">
    {
        "imports": {
            "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
            "three/": "https://cdn.jsdelivr.net/npm/three@0.160.0/",
            "@needle-tools/engine": "https://cdn.jsdelivr.net/npm/@needle-tools/engine@3.37.0/dist/index.js"
        }
    }
    </script>

    <!-- 2. STYLES -->
    <style>
        html, body { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #111; color: white; font-family: sans-serif; overflow: hidden; 
        }
        needle-engine { 
            display: block; width: 100vw; height: 100vh; 
        }
        #overlay { 
            position: absolute; top: 20px; left: 20px; z-index: 100; pointer-events: none; 
            background: rgba(0,0,0,0.7); padding: 15px; border-radius: 8px;
        }
        .error-box {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(50,0,0,0.9); z-index: 9999; padding: 50px;
            display: none; box-sizing: border-box;
        }
    </style>
</head>
<body>

    <!-- Error Display -->
    <div id="error-box" class="error-box">
        <h1>⚠️ Setup Error</h1>
        <p id="error-msg"></p>
        <p><strong>Note:</strong> You cannot run this by double-clicking the file. You must use a local server (e.g., VS Code Live Server, python -m http.server, or GitHub Pages).</p>
    </div>

    <div id="overlay">
        <h2>Tilt Five AR</h2>
        <p>Status: <span id="status" style="color:yellow">Loading Engine...</span></p>
    </div>

    <!-- 3. LOAD ENGINE -->
    <!-- We load the engine module here. The import map handles the URL. -->
    <script type="module" src="https://cdn.jsdelivr.net/npm/@needle-tools/engine@3.37.0/dist/index.js"></script>

    <!-- 4. ENGINE COMPONENT -->
    <needle-engine></needle-engine>

    <!-- 5. MAIN LOGIC -->
    <script type="module">
        import { onStart, WebXR, GameObject } from "@needle-tools/engine";
        import * as THREE from "three";

        // Check for file:// protocol error
        if (window.location.protocol === 'file:') {
            const errBox = document.getElementById('error-box');
            document.getElementById('error-msg').innerText = "You are running this file via 'file://' protocol. Browsers block WebXR and modules in this mode.";
            errBox.style.display = 'block';
            throw new Error("Local file access blocked");
        }

        const statusEl = document.getElementById("status");
        
        onStart((context) => {
            console.log("Needle Engine Started!");
            statusEl.innerText = "Running (Ready for T5)";
            statusEl.style.color = "#00ff00";

            // --- TILT FIVE SETUP ---
            // This component handles the connection to the T5 Drivers
            const xrObject = GameObject.addNew(context.scene, "WebXR_Manager");
            GameObject.addComponent(xrObject, WebXR);

            // --- DESKTOP PREVIEW ---
            if (!context.mainCamera) {
                const cam = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 100);
                cam.position.set(0, 1, 1.5);
                cam.lookAt(0, 0, 0);
                context.scene.add(cam);
                context.mainCamera = cam;
            }

            // --- SCENE CONTENT ---
            const root = new THREE.Group();
            context.scene.add(root);

            // 1. Grid
            context.scene.add(new THREE.GridHelper(2, 10));

            // 2. Objects
            const geometry = new THREE.TorusKnotGeometry(0.15, 0.05, 100, 16);
            const material = new THREE.MeshStandardMaterial({ color: 0x00ff88, metalness: 0.5, roughness: 0.1 });
            const torus = new THREE.Mesh(geometry, material);
            torus.position.y = 0.2;
            root.add(torus);

            // 3. Light
            const light = new THREE.DirectionalLight(0xffffff, 2);
            light.position.set(1, 2, 1);
            context.scene.add(light);
            context.scene.add(new THREE.AmbientLight(0x404040));

            // 4. Animation
            const animate = () => {
                if(context.isDestroyed) return;
                torus.rotation.x += 0.01;
                torus.rotation.y += 0.01;
                requestAnimationFrame(animate);
            };
            animate();
        });
    </script>
</body>
</html>
